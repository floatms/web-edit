<!DOCTYPE html>
<html>
<head>
	<title>Web Editor</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, height=device-height">
</head>
<body>

<style type="text/css">

	#container {
		position: relative;
		width: 100vw;
		height: 100%;
		padding: 0;
		margin: 0;
		/*display: flex;
		justify-content: flex-start;
		flex-direction: column;*/
	}

	#editor-event-catcher {
		width: 100%;
		height: 100%;
	}

	#editor-canvas {
		white-space: pre;

		width: 100%;
		height: 100%;
		/*margin: 2px;
		padding: 2px;*/
		font-family: monospace;
		/*@TODO: Customizable font size */
		font-size: 1.1em; /* 1.25rem */

		white-space: pre-wrap;
		overflow: hidden;
		text-overflow: clip;

		padding: 4px;
		padding-left: 6px;
		padding-top: 10px;

		/*pointer-events: none;*/
	}

	#editor-canvas:focus {
		outline: 0;
	}

	#keyboard-context-menu {
		display: none;
		background-color: red;
		height: 7vh;
		width: 100%;
		position: fixed;
		bottom: 0;
		left: 0;
		padding: 0;
		margin: 0;
	}

	#keyboard-context-menu:active {
		display: flex;
		flex-direction: row;
	}

	#virtual-keyboard {
		display: none;
		position: fixed;
		bottom: 0;
		background-color: lightgrey;
		width: 100vw;
		height: 35vh;

		grid-template-columns: repeat(10, 1fr);
		grid-gap: 0;

		touch-action: manipulation;
	}

	.virtual-button {
		max-height: 20%;
		margin: 2px;
		padding: 2px;
		font-size: 1.7em;

		touch-action: manipulation;
	}

	.virtual-button:focus {
		outline: none;
		box-shadow: none;
	}

	.caret {
		padding: 0;
		margin: 0;
		border: 0;
	}

	body {
		padding: 0;
		margin: 0;
	}

	html, body {
		height: 100%;
		width: 100%;
	}

</style>

<div id="container">
	<div id="editor-event-catcher">
		<div id="editor-canvas" contenteditable="" spellcheck="false" autocapitalize="off"></div>	
	</div>
	<div id="keyboard-context-menu">
		<button id='tab-button' style='width: 20%;'>TAB</button>
		<button id='open-brace-button' style='width: 10%;'>{</button>
		<button id='close-brace-button' style='width: 10%;'>}</button>
		<button id='open-paren-button' style='width: 10%;'>(</button>
		<button id='close-paren-button' style='width: 10%;'>)</button>
		<button id='semicolon-button' style='width: 10%;'>;</button>
	</div>
	<div id="virtual-keyboard">
		<button class="virtual-button" onclick="virtualButtonHandler(this, '0');">0</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '1');">1</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '2');">2</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '3');">3</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '4');">4</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '5');">5</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '6');">6</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '7');">7</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '8');">8</button>
		<button class="virtual-button" onclick="virtualButtonHandler(this, '9');">9</button>
	</div>
</div>

<!-- <div id="TEST" style="position: fixed; bottom: 0; left: 0; background-color: red; width: 100vw; height: 30px;"></div> -->

<script type="text/javascript">

let keyboardMenu;

window.addEventListener('load', function() {
	updateWindowSize();
	window.topBarHeight = screen.height - window.innerHeight;
	keyboardMenu = document.getElementById('keyboard-context-menu');
	window.addEventListener('resize', resizeHandler);

	let editorCanvas = document.getElementById('editor-canvas');
	editorCanvas.hasVirtualFocus = false;
	
	// let virtualKeyboard = document.getElementById('virtual-keyboard');
	let eventCatcher = document.getElementById('editor-event-catcher');

	/*
	eventCatcher.addEventListener('click', function(event) {
		if (!editorCanvas.hasVirtualFocus) {
			editorCanvas.hasVirtualFocus = true;
			// virtualKeyboard.style.display = 'grid';
			updateHTML();
		}
	});
	*/

	document.getElementById('keyboard-context-menu').addEventListener('pointerdown', function(event) {
		event.preventDefault();
	});

	// Keyboard menu buttons
	//@TODO: Refactor. Extract common code and reduce.
	{
		document.getElementById('tab-button').addEventListener('pointerdown', function(event) {
			event.preventDefault();
			window.navigator.vibrate(3);
			insertTextAtSelection('    ');
		});

		document.getElementById('open-brace-button').addEventListener('pointerdown', function(event) {
			event.preventDefault();
			window.navigator.vibrate(3);
			insertTextAtSelection('{');
		});

		document.getElementById('close-brace-button').addEventListener('pointerdown', function(event) {
			event.preventDefault();
			window.navigator.vibrate(3);
			insertTextAtSelection('}');
		});

		document.getElementById('open-paren-button').addEventListener('pointerdown', function(event) {
			event.preventDefault();
			window.navigator.vibrate(3);
			insertTextAtSelection('(');
		});

		document.getElementById('close-paren-button').addEventListener('pointerdown', function(event) {
			event.preventDefault();
			window.navigator.vibrate(3);
			insertTextAtSelection(')');
		});

		document.getElementById('semicolon-button').addEventListener('pointerdown', function(event) {
			event.preventDefault();
			window.navigator.vibrate(3);
			insertTextAtSelection(';');
		});
	}

	editorCanvas.addEventListener('keydown', function(event) {
		switch (event.keyCode) {
		case 9: // Tab
			event.preventDefault();
			insertTextAtSelection('    ');
			break;
		default:
			break;
		}
	});

	window.addEventListener('keydown', function(event) {
		if (!editorCanvas.hasVirtualFocus) {
			return;
		}
		
		switch (event.keyCode) {
		case 9: // Tab
			event.preventDefault();
			insert('    ');
			break;
		case 13: // Enter
			event.preventDefault();
			insert('\n');
			break;
		case 8: // Backspace
			event.preventDefault();
			del();
			break;
		case 16: // Shift
		case 17: // Control
		case 18: // AltGraph
			// do nothing
			break;
		default:
			// event.preventDefault();
			insert(event.key);
			break;
		}
	});
});

//@NOTE: W.I.P. gap-buffer implementation
class Buffer {
	constructor(size) {
		this.buf = new Uint8Array(size);
		this.cursor = 0;
		this.gapstart = 0;
		this.gapend = size;
		this.endpos = size;
		this.encoder = new TextEncoder('utf-8');
		this.decoder = new TextDecoder('utf-8');
	}

	insert(text) {
		this.buf.set(this.encoder.encode(text), this.cursor);
		this.cursor += text.length;
		this.gapstart = this.cursor;
	}

	del() {
		if (this.cursor == 0) {
			return;
		}
		this.cursor--;
		this.gapstart--;
	}

	textBeforeGap() {
		return this.decoder.decode(this.buf.slice(0, this.gapstart));
	}
}

var textBuffer = new Buffer(1024 * 100);

function updateHTML() {
	const elem = document.getElementById('editor-canvas'); 
	elem.innerHTML = textBuffer.textBeforeGap() + '<span class="caret">|</span>';
}

function insert(text) {
	textBuffer.insert(text);
	updateHTML();
}

function del() {
	textBuffer.del();
	updateHTML();
}

// Contenteditable div impl
function insertTextAtSelection(text) {
	if (window.getSelection) {
		let sel = window.getSelection();
		if (sel.getRangeAt && sel.rangeCount) {
			let range = sel.getRangeAt(0);
			range.deleteContents();
			range.insertNode(document.createTextNode(text));
		}
		sel.collapseToEnd();
	} else if (document.selection && document.selection.createRange) {
		document.selection.createRange().text = text;
	}
}

//@TODO: window.navigator.vibrate only works when sound settings of phone
// are set to vibrate at least. Haptic button feedback seems to be something else
// entirely.
function virtualButtonHandler(target, text) {
	insert(text);
	window.navigator.vibrate(1);
	target.blur();
}

function resizeHandler() {

	let kbHeight = detectKeyboard();
	if (kbHeight > 0) {
		console.log('Keyboard shown: ', kbHeight);
		keyboardMenu.style.display = 'flex';
		// keyboardMenu.classList.add('keyboard-context-menu:active');
		// keyboardMenu.style.bottom = `${kbHeight}px`;

		if (!document.fullScreenElement) {
			document.documentElement.requestFullscreen();
		}
	} else if (kbHeight == -1) {
		console.log('Keyboard hidden');
		keyboardMenu.style.display = 'none';
		// keyboardMenu.classList.remove('keyboard-context-menu:active');
	}
}

function updateWindowSize() {
	window.lastInnerWidth = window.innerWidth;
	window.lastInnerHeight = window.innerHeight;
	window.lastOrientation = window.orientation;
	window.lastBodyHeight = document.body.clientHeight;
};

function detectKeyboard() {
	function orientationChange() {
		if ( ((window.lastOrientation == 0 || window.lastOrientation == 180) && (window.orientation == 0 || window.orientation == 180)) || ((window.lastOrientation == 90 || window.lastOrientation == -90) && (window.orientation == 90 || window.orientation == -90)) ) return false
		else return true;
	}
	
	// No orientation change, keyboard opening
	if ( (window.lastInnerHeight - window.innerHeight > 150 ) && window.innerWidth == window.lastInnerWidth ) {
		var keyboardHeight = window.lastInnerHeight - window.innerHeight;
		updateWindowSize();
		return keyboardHeight;
	}
	// Orientation change with keyboard already opened
	if ( orientationChange() && document.body.classList.contains("keyboard-open") ) {
		var keyboardHeight = screen.height - window.topBarHeight - window.innerHeight;
		updateWindowSize();
		return keyboardHeight;
	}
	
	// No orientation change, keyboard closing
	if ( (window.innerHeight - window.lastInnerHeight > 150 ) && window.innerWidth == window.lastInnerWidth) {
		var keyboardHeight = -1;
		updateWindowSize();
		return keyboardHeight;
		
	} 
	
	// Orientation change or regular resize, no keyboard action
	var keyboardHeight = 0;
	updateWindowSize();
	return keyboardHeight;
}

</script>


</body>
</html>